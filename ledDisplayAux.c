#include "ledDisplayAux.h"


#define NUM_COLUMN_DISPLAYAUX 8

uchar *data;
uchar display[8];

char characters[37] = { 
	'0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
	'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',
	'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',
	'U', 'V', 'W', 'X', 'Y', 'Z', ' ' 
};

uchar icons[3][8] = {
{0x00,0x00,0x55,0x55,0x75,0x54,0x55,0x00},//Hi!
{0xFF,0xFF,0x00,0x00,0x20,0x00,0x00,0x1C},// arkanoPi
{0x1C,0x00,0x00,0x00,0x08,0x00,0x00,0x38}// pong
};

uchar nums[10][8] = {
{0x00,0x0E,0x0A,0x0A,0x0A,0x0A,0x0E,0x00},//00
{0x00,0x02,0x06,0x0A,0x02,0x02,0x02,0x00},//01
{0x00,0x04,0x0A,0x02,0x04,0x08,0x0E,0x00},//02
{0x00,0x0E,0x02,0x0E,0x02,0x02,0x0E,0x00},//03
{0x00,0x02,0x06,0x0A,0x0F,0x02,0x02,0x00},//04
{0x00,0x0E,0x08,0x0C,0x02,0x02,0x0C,0x00},//05
{0x00,0x0E,0x08,0x0E,0x0A,0x0A,0x0E,0x00},//06
{0x00,0x0E,0x02,0x07,0x02,0x02,0x02,0x00},//07
{0x00,0x0E,0x0A,0x0E,0x0A,0x0A,0x0E,0x00},//08
{0x00,0x0E,0x0A,0x0E,0x02,0x02,0x02,0x00},//09

};

uchar letters[37][8] ={
{0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
{0x10,0x30,0x50,0x10,0x10,0x10,0x10,0x7C},//1
{0x3E,0x02,0x02,0x3E,0x20,0x20,0x3E,0x00},//2
{0x00,0x7C,0x04,0x04,0x7C,0x04,0x04,0x7C},//3
{0x08,0x18,0x28,0x48,0xFE,0x08,0x08,0x08},//4
{0x3C,0x20,0x20,0x3C,0x04,0x04,0x3C,0x00},//5
{0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x00},//6
{0x3E,0x22,0x04,0x08,0x08,0x08,0x08,0x08},//7
{0x00,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
{0x3E,0x22,0x22,0x3E,0x02,0x02,0x02,0x3E},//9
{0x08,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
{0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x00},//B
{0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x00},//C
{0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x00},//D
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
{0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
{0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
{0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
{0x3C,0x08,0x08,0x08,0x08,0x08,0x48,0x30},//J
{0x00,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
{0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
{0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
{0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x00},//N
{0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
{0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
{0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
{0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
{0x00,0x1E,0x20,0x20,0x3E,0x02,0x02,0x3C},//S
{0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08},//T
{0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
{0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
{0x00,0x49,0x49,0x49,0x49,0x2A,0x1C,0x00},//W
{0x00,0x41,0x22,0x14,0x08,0x14,0x22,0x41},//X
{0x41,0x22,0x14,0x08,0x08,0x08,0x08,0x08},//Y
{0x00,0x7F,0x02,0x04,0x08,0x10,0x20,0x7F},//Z
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//space
};


void Delay_xms(uint x)
{
	delay(x);
}

void clear(){
	int i;
	for(i = 0; i < NUM_COLUMN_DISPLAYAUX; i++) {
		Write_SPI(i+1, 0);
	}
}

int power(int x, int y){
	int res = 1;
	int i;
	for(i=0; i<y; i++) {
		res *=x;
	}
	return res;
}

int* split_num(int x){
	static int arr[2];

	arr[0]= x%10;
	arr[1]= (x/10);

	return arr;
}

void Write_SPI(uchar reg, uchar data)
{
	uint8_t buf[2];
	buf[0] = reg;
	buf[1] = data;

	wiringPiSPIDataRW(SPI_CHANNEL, buf, 2);
}

void ActualizaDisplayAux(){
	int i;
	for(i = 0; i < NUM_COLUMN_DISPLAYAUX; i++) {
		/* Write_SPI(i+1, *((disp+char1*NUM_COLUMN_DISPLAYAUX)+i)); */
		Write_SPI(i+1, display[i]);
	}
}

void InitSPI()
{
	if (wiringPiSPISetup(SPI_CHANNEL, CLOCK_SPEED) < 0) {
	    fprintf (stderr, "Unable to setup wiringPiSpi: %s\n", strerror (errno)) ;
	    return;
	}
	Write_SPI(0x09,0x00);
	Write_SPI(0x0B,0x07);
	Write_SPI(0x0A,0xFF);
	Write_SPI(0x0C,0x01);

	/* Write_SPI(0x09,0x00); */
	/* Write_SPI(0x0a,0x03); */
	/* Write_SPI(0x0b,0x07); */
	/* Write_SPI(0x0c,0x01); */
	/* Write_SPI(0x0f,0x00); */
}

uchar find_char(char letter) {
	uchar index;
	for (index = 0; index < 37; index++) {
		if (letter == characters[index]) {
			return index;
		}
	}
	//Character not found, return index of space
	return 36;
}

/* void led_print(int char1) { */
void led_print(int char1, uchar *disp) {
	uchar i;
	for(i = 0; i < NUM_COLUMN_DISPLAYAUX; i++) {
		Write_SPI(i+1, *((disp+char1*NUM_COLUMN_DISPLAYAUX)+i));
	}
}

void push(char col){
	int i;
	for(i = 0; i < NUM_COLUMN_DISPLAYAUX - 1; i++) {
		display[i] = display[i+1];
	}
	display[NUM_COLUMN_DISPLAYAUX-1] = col;
}

/* int led_text_main(int argc, char *argv[]) */
int led_text_main(char argv[], int delay)
{
	InitSPI();
	
	int score[1];
	 score[0] = 13; 
	 //score[1] = 7; 

	/* display_score(score, sizeof(score)/sizeof(int)); */

	/* int *test = split_num(score[0]); */
	/* printf("Unidades: %d\n", *test); */
	/* printf("Decenas: %d\n", *(test+1)); */

	/* size_t index = 0; */
	/* while (index < strlen(argv)) { */
	/* 	// Retrive first letter */
	/* 	char letter1 = toupper(argv[index]); */
	/* 	led_print(find_char(letter1), (uchar *)disp1); */
	/* 	Delay_xms(delay); */
	/* 	index++; */
	/* } */

	restartGPIO();
	return 0;
}

void display_score(int score[], int nPlayers){
	if(nPlayers > 2) {
		printf("Too many characters to display\n");
		return; 
	}
	
	/* if(nPlayers == 1 && score[0]>=10) { */
	if(nPlayers == 1 ) {
		score = split_num(score[0]);
		nPlayers = 2;
	}

	int i;
	for (i = 0; i< NUM_COLUMN_DISPLAYAUX; i++){
		data = nums[score[0]][i];

		int player;
		for(player = 1; player < nPlayers; player++){
			data += nums[score[player]][i]*power(16, player) ;
		}
		Write_SPI(i+1, data); 
	}
}

void display_countdown(int start, int delay){
	while(start >= 1){
		int i;
		for (i = 0; i< NUM_COLUMN_DISPLAYAUX; i++){
			data = letters[start][i];
			Write_SPI(i+1, data); 
		}
		printf("%d\n", start);
		Delay_xms(delay);
		start--;
	}
}

void display_icon(int icon){
	printf("%d\n", icon);
	int i;
	for (i = 0; i< NUM_COLUMN_DISPLAYAUX; i++){
		data = icons[icon][i];
		Write_SPI(i+1, data); 
	}
}

void display_text(char* text){
	int i = 0;
	for(i=0; i < strlen(text); i++) {
		char letter = toupper(text[i]);
		
		int col; 
		for(col=0; col<NUM_COLUMN_DISPLAYAUX; col++){
			push(letters[find_char(letter)][col]);
			ActualizaDisplayAux();
			Delay_xms(100);
		}

	}
	
}
